<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="\[ \] ç¬¬ä¸€ç¬”äº¤æ˜“ # ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†æµåŠ¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€ç¬”äº¤æ˜“äº†ï¼
è®¡ç®—äº¤æ˜“æ•°é‡ # é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å¦‚ä½•è®¡ç®—äº¤æ˜“å‡ºå…¥çš„æ•°é‡ã€‚åŒæ ·ï¼Œæˆ‘ä»¬åœ¨è¿™å°èŠ‚ä¸­ä¹Ÿä¼šç¡¬ç¼–ç æˆ‘ä»¬å¸Œæœ›äº¤æ˜“çš„USDCæ•°é¢ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©42ï¼Œä¹Ÿå³èŠ±è´¹42USDCè´­ä¹°ETH
åœ¨å†³å®šäº†æˆ‘ä»¬å¸Œæœ›æŠ•å…¥çš„èµ„é‡‘é‡ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æˆ‘ä»¬ä¼šè·å¾—å¤šå°‘tokenã€‚åœ¨Uniswap V2ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ç°åœ¨æ± å­çš„èµ„äº§æ•°é‡æ¥è®¡ç®—ï¼Œä½†æ˜¯åœ¨V3ä¸­æˆ‘ä»¬æœ‰$L$å’Œ$\sqrt{P}$ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“åœ¨äº¤æ˜“è¿‡ç¨‹ä¸­ï¼Œ$L$ä¿æŒä¸å˜è€Œåªæœ‰$\sqrt{P}$å‘ç”Ÿå˜åŒ–ï¼ˆå½“åœ¨åŒä¸€åŒºé—´å†…è¿›è¡Œäº¤æ˜“æ—¶ï¼ŒV3çš„è¡¨ç°å’ŒV2ä¸€è‡´ï¼‰ã€‚æˆ‘ä»¬è¿˜çŸ¥é“å¦‚ä¸‹å…¬å¼ï¼š
$$L = \frac{\Delta y}{\Delta \sqrt{P}}$$
å¹¶ä¸”ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†$\Delta y$ï¼å®ƒæ­£æ˜¯æˆ‘ä»¬å¸Œæœ›æŠ•å…¥çš„42USDCã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…¬å¼å¾—å‡ºæŠ•å…¥çš„ 42USDC ä¼šå¯¹ä»·æ ¼é€ æˆå¤šå°‘å½±å“ï¼š
$$\Delta \sqrt{P} = \frac{\Delta y}{L}$$
åœ¨V3ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©æˆ‘ä»¬å¸Œæœ›äº¤æ˜“å¯¼è‡´çš„ä»·æ ¼å˜åŠ¨ï¼ˆå›å¿†ä¸€ä¸‹ï¼Œäº¤æ˜“ä½¿å¾—ç°ä»·æ²¿ç€æ›²çº¿ç§»åŠ¨ï¼‰ã€‚çŸ¥é“äº†ç›®æ ‡ä»·æ ¼(target price)ï¼Œåˆçº¦å¯ä»¥è®¡ç®—å‡ºæŠ•å…¥tokençš„æ•°é‡å’Œè¾“å‡ºtokençš„æ•°é‡ã€‚
æˆ‘ä»¬å°†æ•°å­—ä»£å…¥ä¸Šè¿°å…¬å¼ï¼š
$$\Delta \sqrt{P} = \frac{42 \enspace USDC}{1517882343751509868544} = 2192253463713690532467206957$$
æŠŠå·®ä»·åŠ åˆ°ç°åœ¨çš„$\sqrt{P}$ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°ç›®æ ‡ä»·æ ¼ï¼š
$$\sqrt{P_{target}} = \sqrt{P_{current}} &#43; \Delta \sqrt{P}$$
$$\sqrt{P_{target}} = 5604469350942327889444743441197$$
åœ¨Pythonä¸­è¿›è¡Œç›¸åº”è®¡ç®—:
amount_in = 42 * eth price_diff = (amount_in * q96) // liq price_next = sqrtp_cur &#43; price_diff print(&#34;New price:&#34;, (price_next / q96) ** 2) print(&#34;New sqrtP:&#34;, price_next) print(&#34;New tick:&#34;, price_to_tick((price_next / q96) ** 2)) # New price: 5003.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="ç¬¬ä¸€ç¬”äº¤æ˜“" />
<meta property="og:description" content="\[ \] ç¬¬ä¸€ç¬”äº¤æ˜“ # ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†æµåŠ¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€ç¬”äº¤æ˜“äº†ï¼
è®¡ç®—äº¤æ˜“æ•°é‡ # é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å¦‚ä½•è®¡ç®—äº¤æ˜“å‡ºå…¥çš„æ•°é‡ã€‚åŒæ ·ï¼Œæˆ‘ä»¬åœ¨è¿™å°èŠ‚ä¸­ä¹Ÿä¼šç¡¬ç¼–ç æˆ‘ä»¬å¸Œæœ›äº¤æ˜“çš„USDCæ•°é¢ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©42ï¼Œä¹Ÿå³èŠ±è´¹42USDCè´­ä¹°ETH
åœ¨å†³å®šäº†æˆ‘ä»¬å¸Œæœ›æŠ•å…¥çš„èµ„é‡‘é‡ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æˆ‘ä»¬ä¼šè·å¾—å¤šå°‘tokenã€‚åœ¨Uniswap V2ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ç°åœ¨æ± å­çš„èµ„äº§æ•°é‡æ¥è®¡ç®—ï¼Œä½†æ˜¯åœ¨V3ä¸­æˆ‘ä»¬æœ‰$L$å’Œ$\sqrt{P}$ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“åœ¨äº¤æ˜“è¿‡ç¨‹ä¸­ï¼Œ$L$ä¿æŒä¸å˜è€Œåªæœ‰$\sqrt{P}$å‘ç”Ÿå˜åŒ–ï¼ˆå½“åœ¨åŒä¸€åŒºé—´å†…è¿›è¡Œäº¤æ˜“æ—¶ï¼ŒV3çš„è¡¨ç°å’ŒV2ä¸€è‡´ï¼‰ã€‚æˆ‘ä»¬è¿˜çŸ¥é“å¦‚ä¸‹å…¬å¼ï¼š
$$L = \frac{\Delta y}{\Delta \sqrt{P}}$$
å¹¶ä¸”ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†$\Delta y$ï¼å®ƒæ­£æ˜¯æˆ‘ä»¬å¸Œæœ›æŠ•å…¥çš„42USDCã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…¬å¼å¾—å‡ºæŠ•å…¥çš„ 42USDC ä¼šå¯¹ä»·æ ¼é€ æˆå¤šå°‘å½±å“ï¼š
$$\Delta \sqrt{P} = \frac{\Delta y}{L}$$
åœ¨V3ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©æˆ‘ä»¬å¸Œæœ›äº¤æ˜“å¯¼è‡´çš„ä»·æ ¼å˜åŠ¨ï¼ˆå›å¿†ä¸€ä¸‹ï¼Œäº¤æ˜“ä½¿å¾—ç°ä»·æ²¿ç€æ›²çº¿ç§»åŠ¨ï¼‰ã€‚çŸ¥é“äº†ç›®æ ‡ä»·æ ¼(target price)ï¼Œåˆçº¦å¯ä»¥è®¡ç®—å‡ºæŠ•å…¥tokençš„æ•°é‡å’Œè¾“å‡ºtokençš„æ•°é‡ã€‚
æˆ‘ä»¬å°†æ•°å­—ä»£å…¥ä¸Šè¿°å…¬å¼ï¼š
$$\Delta \sqrt{P} = \frac{42 \enspace USDC}{1517882343751509868544} = 2192253463713690532467206957$$
æŠŠå·®ä»·åŠ åˆ°ç°åœ¨çš„$\sqrt{P}$ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°ç›®æ ‡ä»·æ ¼ï¼š
$$\sqrt{P_{target}} = \sqrt{P_{current}} &#43; \Delta \sqrt{P}$$
$$\sqrt{P_{target}} = 5604469350942327889444743441197$$
åœ¨Pythonä¸­è¿›è¡Œç›¸åº”è®¡ç®—:
amount_in = 42 * eth price_diff = (amount_in * q96) // liq price_next = sqrtp_cur &#43; price_diff print(&#34;New price:&#34;, (price_next / q96) ** 2) print(&#34;New sqrtP:&#34;, price_next) print(&#34;New tick:&#34;, price_to_tick((price_next / q96) ** 2)) # New price: 5003." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://uniswapv3book.com/docs/milestone_1/first-swap/" /><meta property="article:section" content="docs" />



<title>ç¬¬ä¸€ç¬”äº¤æ˜“ | Uniswap V3 Book ä¸­æ–‡ç‰ˆ</title>
<link rel="manifest" href="https://uniswapv3book.com/manifest.json">
<link rel="icon" href="https://uniswapv3book.com/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="https://uniswapv3book.com/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css" integrity="sha256-gsXb0jRHzuC0wqo&#43;0Izglh&#43;qQOH6Nw7uT4yfAuDUa18=" crossorigin="anonymous">
  <script defer src="https://uniswapv3book.com/flexsearch.min.js"></script>
  <script defer src="https://uniswapv3book.com/en.search.min.7bcb9cc1edbdbe78ffa7aeda28e09d51033768c24a465538e9da7066e43237d4.js" integrity="sha256-e8ucwe29vnj/p67aKOCdUQM3aMJKRlU46dpwZuQyN9Q=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="https://uniswapv3book.com/"><span>Uniswap V3 Book ä¸­æ–‡ç‰ˆ</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 0. ç®€ä»‹</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/introduction-to-markets/" class="">äº¤æ˜“å¸‚åœºç®€ä»‹</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/constant-function-market-maker/" class="">æ’å®šå‡½æ•°åšå¸‚å•†(CFMM)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/uniswap-v3/" class="">Uniswap V3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/introduction/dev-environment/" class="">å¼€å‘ç¯å¢ƒ</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 1. ç¬¬ä¸€ç¬”äº¤æ˜“</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/introduction/" class="">ç®€ä»‹</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/calculating-liquidity/" class="">è®¡ç®—æµåŠ¨æ€§</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/providing-liquidity/" class="">æä¾›æµåŠ¨æ€§</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/first-swap/" class="active">ç¬¬ä¸€ç¬”äº¤æ˜“</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/manager-contract/" class="">ç®¡ç†åˆçº¦</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/deployment/" class="">éƒ¨ç½²åˆçº¦</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_1/user-interface/" class="">ç”¨æˆ·ç•Œé¢</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 2. ç¬¬äºŒç¬”äº¤æ˜“</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/introduction/" class="">ç®€ä»‹</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/output-amount-calculation/" class="">è¾“å‡ºé‡‘é¢è®¡ç®—</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/math-in-solidity/" class="">Solidityä¸­çš„æ•°å­¦è¿ç®—</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/tick-bitmap-index/" class="">Tick Bitmap Index</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/generalize-minting/" class="">é€šç”¨mint</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/generalize-swapping/" class="">é€šç”¨swap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/quoter-contract/" class="">æŠ¥ä»·åˆçº¦</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_2/user-interface/" class="">ç”¨æˆ·ç•Œé¢</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 3. è·¨tickäº¤æ˜“</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/introduction/" class="">ç®€ä»‹</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/different-ranges/" class="">ä¸åŒä»·æ ¼åŒºé—´</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/cross-tick-swaps/" class="">Cross-Tick Swaps</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/slippage-protection/" class="">Slippage Protection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/liquidity-calculation/" class="">Liquidity Calculation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/more-on-fixed-point-numbers/" class="">A Little Bit More on Fixed-point Numbers</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/flash-loans/" class="">Flash Loans</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_3/user-interface/" class="">User Interface</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 4. Multi-pool Swaps</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/factory-contract/" class="">Factory Contract</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/path/" class="">Swap Path</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/multi-pool-swaps/" class="">Multi-pool Swaps</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/user-interface/" class="">User Interface</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_4/tick-rounding/" class="">Tick Rounding</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 5. Fees and Price Oracle</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/swap-fees/" class="">Swap Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/flash-loan-fees/" class="">Flash Loan Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/protocol-fees/" class="">Protocol Fees</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/price-oracle/" class="">Price Oracle</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_5/user-interface/" class="">User Interface</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Milestone 6: NFT positions</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/introduction/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/erc721-overview/" class="">ERC721 Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/nft-manager/" class="">NFT Manager</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/milestone_6/nft-renderer/" class="">NFT Renderer</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>è¡¥å……èµ„æ–™</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://uniswapv3book.com/docs/reference/dictionary/" class="">ä¸­è‹±åè¯å¯¹ç…§</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="https://uniswapv3book.com/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>ç¬¬ä¸€ç¬”äº¤æ˜“</strong>

  <label for="toc-control">
    
    <img src="https://uniswapv3book.com/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#ç¬¬ä¸€ç¬”äº¤æ˜“">ç¬¬ä¸€ç¬”äº¤æ˜“</a>
      <ul>
        <li><a href="#è®¡ç®—äº¤æ˜“æ•°é‡">è®¡ç®—äº¤æ˜“æ•°é‡</a></li>
        <li><a href="#å®ç°swap">å®ç°swap</a></li>
        <li><a href="#æµ‹è¯•äº¤æ˜“">æµ‹è¯•äº¤æ˜“</a></li>
        <li><a href="#ç»ƒä¹ ">ç»ƒä¹ </a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown">
<link rel="stylesheet" href="https://uniswapv3book.com/katex/katex.min.css" />
<script>
  function renderKatex(element) {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false },
        { left: '\\[', right: '\\]', display: true }
      ],
      
      throwOnError: false
    });
  }
</script>
<script defer src="https://uniswapv3book.com/katex/katex.min.js"></script>
<script defer src="https://uniswapv3book.com/katex/auto-render.min.js" onload="renderKatex(document.body)"></script><span>
  \[ \]
</span>
<h1 id="ç¬¬ä¸€ç¬”äº¤æ˜“">
  ç¬¬ä¸€ç¬”äº¤æ˜“
  <a class="anchor" href="#%e7%ac%ac%e4%b8%80%e7%ac%94%e4%ba%a4%e6%98%93">#</a>
</h1>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†æµåŠ¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€ç¬”äº¤æ˜“äº†ï¼</p>
<h2 id="è®¡ç®—äº¤æ˜“æ•°é‡">
  è®¡ç®—äº¤æ˜“æ•°é‡
  <a class="anchor" href="#%e8%ae%a1%e7%ae%97%e4%ba%a4%e6%98%93%e6%95%b0%e9%87%8f">#</a>
</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å¦‚ä½•è®¡ç®—äº¤æ˜“å‡ºå…¥çš„æ•°é‡ã€‚åŒæ ·ï¼Œæˆ‘ä»¬åœ¨è¿™å°èŠ‚ä¸­ä¹Ÿä¼šç¡¬ç¼–ç æˆ‘ä»¬å¸Œæœ›äº¤æ˜“çš„USDCæ•°é¢ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©42ï¼Œä¹Ÿå³èŠ±è´¹42USDCè´­ä¹°ETH</p>
<p>åœ¨å†³å®šäº†æˆ‘ä»¬å¸Œæœ›æŠ•å…¥çš„èµ„é‡‘é‡ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æˆ‘ä»¬ä¼šè·å¾—å¤šå°‘tokenã€‚åœ¨Uniswap V2ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ç°åœ¨æ± å­çš„èµ„äº§æ•°é‡æ¥è®¡ç®—ï¼Œä½†æ˜¯åœ¨V3ä¸­æˆ‘ä»¬æœ‰$L$å’Œ$\sqrt{P}$ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“åœ¨äº¤æ˜“è¿‡ç¨‹ä¸­ï¼Œ$L$ä¿æŒä¸å˜è€Œåªæœ‰$\sqrt{P}$å‘ç”Ÿå˜åŒ–ï¼ˆå½“åœ¨åŒä¸€åŒºé—´å†…è¿›è¡Œäº¤æ˜“æ—¶ï¼ŒV3çš„è¡¨ç°å’ŒV2ä¸€è‡´ï¼‰ã€‚æˆ‘ä»¬è¿˜çŸ¥é“å¦‚ä¸‹å…¬å¼ï¼š</p>
<p>$$L = \frac{\Delta y}{\Delta \sqrt{P}}$$</p>
<p>å¹¶ä¸”ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†$\Delta y$ï¼å®ƒæ­£æ˜¯æˆ‘ä»¬å¸Œæœ›æŠ•å…¥çš„42USDCã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…¬å¼å¾—å‡ºæŠ•å…¥çš„ 42USDC ä¼šå¯¹ä»·æ ¼é€ æˆå¤šå°‘å½±å“ï¼š</p>
<p>$$\Delta \sqrt{P} = \frac{\Delta y}{L}$$</p>
<p>åœ¨V3ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©<strong>æˆ‘ä»¬å¸Œæœ›äº¤æ˜“å¯¼è‡´çš„ä»·æ ¼å˜åŠ¨</strong>ï¼ˆå›å¿†ä¸€ä¸‹ï¼Œäº¤æ˜“ä½¿å¾—ç°ä»·æ²¿ç€æ›²çº¿ç§»åŠ¨ï¼‰ã€‚çŸ¥é“äº†ç›®æ ‡ä»·æ ¼(target price)ï¼Œåˆçº¦å¯ä»¥è®¡ç®—å‡ºæŠ•å…¥tokençš„æ•°é‡å’Œè¾“å‡ºtokençš„æ•°é‡ã€‚</p>
<p>æˆ‘ä»¬å°†æ•°å­—ä»£å…¥ä¸Šè¿°å…¬å¼ï¼š</p>
<p>$$\Delta \sqrt{P} = \frac{42 \enspace USDC}{1517882343751509868544} = 2192253463713690532467206957$$</p>
<p>æŠŠå·®ä»·åŠ åˆ°ç°åœ¨çš„$\sqrt{P}$ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°ç›®æ ‡ä»·æ ¼ï¼š</p>
<p>$$\sqrt{P_{target}} = \sqrt{P_{current}} + \Delta \sqrt{P}$$</p>
<p>$$\sqrt{P_{target}} = 5604469350942327889444743441197$$</p>
<blockquote>
<p>åœ¨Pythonä¸­è¿›è¡Œç›¸åº”è®¡ç®—:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>amount_in <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span> <span style="color:#f92672">*</span> eth
</span></span><span style="display:flex;"><span>price_diff <span style="color:#f92672">=</span> (amount_in <span style="color:#f92672">*</span> q96) <span style="color:#f92672">//</span> liq
</span></span><span style="display:flex;"><span>price_next <span style="color:#f92672">=</span> sqrtp_cur <span style="color:#f92672">+</span> price_diff
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;New price:&#34;</span>, (price_next <span style="color:#f92672">/</span> q96) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;New sqrtP:&#34;</span>, price_next)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;New tick:&#34;</span>, price_to_tick((price_next <span style="color:#f92672">/</span> q96) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New price: 5003.913912782393</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New sqrtP: 5604469350942327889444743441197</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New tick: 85184</span>
</span></span></code></pre></div></blockquote>
<p>çŸ¥é“äº†ç›®æ ‡ä»·æ ¼ï¼Œæˆ‘ä»¬å°±èƒ½è®¡ç®—å‡ºæŠ•å…¥tokençš„æ•°é‡å’Œè·å¾—tokençš„æ•°é‡ï¼š</p>
<p>$$ x = \frac{L(\sqrt{p_b}-\sqrt{p_a})}{\sqrt{p_b}\sqrt{p_a}}$$
$$ y = L(\sqrt{p_b}-\sqrt{p_a}) $$</p>
<blockquote>
<p>ç”¨Python:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>amount_in <span style="color:#f92672">=</span> calc_amount1(liq, price_next, sqrtp_cur)
</span></span><span style="display:flex;"><span>amount_out <span style="color:#f92672">=</span> calc_amount0(liq, price_next, sqrtp_cur)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;USDC in:&#34;</span>, amount_in <span style="color:#f92672">/</span> eth)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;ETH out:&#34;</span>, amount_out <span style="color:#f92672">/</span> eth)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># USDC in: 42.0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ETH out: 0.008396714242162444</span>
</span></span></code></pre></div></blockquote>
<p>æˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªå…¬å¼éªŒè¯ä¸€ä¸‹ï¼š</p>
<p>$$\Delta x = \Delta \frac{1}{\sqrt{P}} L$$</p>
<p>ä½¿ç”¨ä¸Šè¿°å…¬å¼ï¼Œåœ¨çŸ¥é“ä»·æ ¼å˜åŠ¨å’ŒæµåŠ¨æ€§æ•°é‡çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬èƒ½æ±‚å‡ºæˆ‘ä»¬è´­ä¹°äº†å¤šå°‘ETHï¼Œä¹Ÿå³$\Delta x$ã€‚ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼š $\Delta \frac{1}{\sqrt{P}}$ ä¸ç­‰äº
$\frac{1}{\Delta \sqrt{P}}$ï¼å‰è€…æ‰æ˜¯ETHä»·æ ¼çš„å˜åŠ¨ï¼Œå¹¶ä¸”èƒ½å¤Ÿç”¨å¦‚ä¸‹å…¬å¼è®¡ç®—ï¼š</p>
<p>$$\Delta \frac{1}{\sqrt{P}} = \frac{1}{\sqrt{P_{target}}} - \frac{1}{\sqrt{P_{current}}}$$</p>
<p>æˆ‘ä»¬çŸ¥é“äº†å…¬å¼é‡Œé¢çš„æ‰€æœ‰æ•°å€¼ï¼Œæ¥ä¸‹æ¥å°†å…¶å¸¦å…¥å³å¯ï¼ˆå¯èƒ½ä¼šåœ¨å±å¹•æ˜¾ç¤ºä¸Šæœ‰äº›é—®é¢˜ï¼‰ï¼š</p>
<p>$$\Delta \frac{1}{\sqrt{P}} = \frac{1}{5604469350942327889444743441197} - \frac{1}{5602277097478614198912276234240}$$</p>
<p>$$\Delta \frac{1}{\sqrt{P}} = -0.00000553186106731426$$</p>
<p>æ¥ä¸‹æ¥è®¡ç®— $\Delta x$:</p>
<p>$$\Delta x = -0.00000553186106731426 * 1517882343751509868544 = -8396714242162698 $$</p>
<p>å³ 0.008396714242162698 ETHï¼Œè¿™ä¸æˆ‘ä»¬ç¬¬ä¸€æ¬¡ç®—å‡ºæ¥çš„æ•°é‡éå¸¸æ¥è¿‘ï¼æ³¨æ„åˆ°è¿™ä¸ªç»“æœæ˜¯è´Ÿæ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ä»æ± å­ä¸­ç§»å‡ºETHã€‚</p>
<h2 id="å®ç°swap">
  å®ç°swap
  <a class="anchor" href="#%e5%ae%9e%e7%8e%b0swap">#</a>
</h2>
<p>äº¤æ˜“åœ¨<code>swap</code>å‡½æ•°ä¸­å®ç°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">swap</span>(<span style="color:#66d9ef">address</span> recipient)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">returns</span> (<span style="color:#66d9ef">int256</span> amount0, <span style="color:#66d9ef">int256</span> amount1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><p>æ­¤æ—¶ï¼Œå®ƒä»…ä»…æ¥å—ä¸€ä¸ªrecipientå‚æ•°ï¼Œå³æ”¾å‡ºtokençš„æ¥æ”¶è€…ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å‡ºç›®æ ‡ä»·æ ¼å’Œå¯¹åº”tickï¼Œä»¥åŠtokençš„æ•°é‡ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å°†ä¼šåœ¨è¿™é‡Œç¡¬ç¼–ç æˆ‘ä»¬ä¹‹å‰è®¡ç®—å‡ºæ¥çš„å€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int24</span> nextTick <span style="color:#f92672">=</span> <span style="color:#ae81ff">85184</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint160</span> nextPrice <span style="color:#f92672">=</span> <span style="color:#ae81ff">5604469350942327889444743441197</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>amount0 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">008396714242162444</span> <span style="color:#66d9ef">ether</span>;
</span></span><span style="display:flex;"><span>amount1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span> <span style="color:#66d9ef">ether</span>;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°ç°åœ¨çš„tickå’Œå¯¹åº”çš„<code>sqrtP</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>(slot0.tick, slot0.sqrtPriceX96) <span style="color:#f92672">=</span> (nextTick, nextPrice);
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>ç„¶åï¼Œåˆçº¦æŠŠå¯¹åº”çš„tokenå‘é€ç»™recipientå¹¶ä¸”è®©è°ƒç”¨è€…å°†éœ€è¦çš„tokenè½¬ç§»åˆ°æœ¬åˆçº¦ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>IERC20(token0).transfer(recipient, <span style="color:#66d9ef">uint256</span>(<span style="color:#f92672">-</span>amount0));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint256</span> balance1Before <span style="color:#f92672">=</span> balance1();
</span></span><span style="display:flex;"><span>IUniswapV3SwapCallback(msg.sender).uniswapV3SwapCallback(
</span></span><span style="display:flex;"><span>    amount0,
</span></span><span style="display:flex;"><span>    amount1
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (balance1Before <span style="color:#f92672">+</span> <span style="color:#66d9ef">uint256</span>(amount1) <span style="color:#f92672">&lt;</span> balance1())
</span></span><span style="display:flex;"><span>    revert InsufficientInputAmount();
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>æˆ‘ä»¬ä½¿ç”¨callbackå‡½æ•°æ¥å°†æ§åˆ¶æµè½¬ç§»åˆ°è°ƒç”¨è€…ï¼Œè®©å®ƒè½¬å…¥tokenï¼Œä¹‹åæˆ‘ä»¬éœ€è¦é€šè¿‡æ£€æŸ¥ç¡®è®¤callerè½¬å…¥äº†æ­£ç¡®çš„æ•°é¢ã€‚</p>
<p>æœ€åï¼Œåˆçº¦é‡Šæ”¾å‡ºä¸€ä¸ª<code>swap</code>äº‹ä»¶ï¼Œä½¿å¾—è¯¥ç¬”äº¤æ˜“èƒ½å¤Ÿè¢«ç›‘å¬åˆ°ã€‚è¿™ä¸ªäº‹ä»¶åŒ…å«äº†æ‰€æœ‰æœ‰å…³è¿™ç¬”äº¤æ˜“çš„ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>emit Swap(
</span></span><span style="display:flex;"><span>    msg.sender,
</span></span><span style="display:flex;"><span>    recipient,
</span></span><span style="display:flex;"><span>    amount0,
</span></span><span style="display:flex;"><span>    amount1,
</span></span><span style="display:flex;"><span>    slot0.sqrtPriceX96,
</span></span><span style="display:flex;"><span>    liquidity,
</span></span><span style="display:flex;"><span>    slot0.tick
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>è¿™æ ·å°±å®Œæˆäº†ï¼è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½ä»…ä»…æ˜¯å°†ä¸€äº›tokenå‘é€åˆ°äº†æŒ‡å®šçš„æ¥æ”¶åœ°å€ï¼Œå¹¶ä¸”ä»è°ƒç”¨è€…å¤„æ¥å—ä¸€å®šæ•°é‡çš„å¦ä¸€ç§tokenã€‚éšç€æœ¬ä¹¦çš„è¿›å±•ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚</p>
<h2 id="æµ‹è¯•äº¤æ˜“">
  æµ‹è¯•äº¤æ˜“
  <a class="anchor" href="#%e6%b5%8b%e8%af%95%e4%ba%a4%e6%98%93">#</a>
</h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•<code>swap</code>å‡½æ•°ã€‚åœ¨ç›¸åŒçš„æµ‹è¯•æ–‡ä»¶ä¸­ï¼ˆè¯‘è€…æ³¨ï¼š<code>UniswapV3Pool.t.sol</code>ï¼‰ï¼Œåˆ›å»º<code>testSwapBuyEth</code>å‡½æ•°å¹¶è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ã€‚å‡†å¤‡é˜¶æ®µçš„å‚æ•°ä¸<code>testMintSuccess</code>ä¸€è‡´ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">testSwapBuyEth</span>() <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    TestCaseParams <span style="color:#66d9ef">memory</span> params <span style="color:#f92672">=</span> TestCaseParams({
</span></span><span style="display:flex;"><span>        wethBalance<span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">ether</span>,
</span></span><span style="display:flex;"><span>        usdcBalance<span style="color:#f92672">:</span> <span style="color:#ae81ff">5000</span> <span style="color:#66d9ef">ether</span>,
</span></span><span style="display:flex;"><span>        currentTick<span style="color:#f92672">:</span> <span style="color:#ae81ff">85176</span>,
</span></span><span style="display:flex;"><span>        lowerTick<span style="color:#f92672">:</span> <span style="color:#ae81ff">84222</span>,
</span></span><span style="display:flex;"><span>        upperTick<span style="color:#f92672">:</span> <span style="color:#ae81ff">86129</span>,
</span></span><span style="display:flex;"><span>        liquidity<span style="color:#f92672">:</span> <span style="color:#ae81ff">1517882343751509868544</span>,
</span></span><span style="display:flex;"><span>        currentSqrtP<span style="color:#f92672">:</span> <span style="color:#ae81ff">5602277097478614198912276234240</span>,
</span></span><span style="display:flex;"><span>        shouldTransferInCallback<span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        mintLiqudity<span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">uint256</span> poolBalance0, <span style="color:#66d9ef">uint256</span> poolBalance1) <span style="color:#f92672">=</span> setupTestCase(params);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><blockquote>
<p>æˆ‘ä»¬ä¸ä¼šæµ‹è¯•æµåŠ¨æ€§æ˜¯å¦æ­£ç¡®æ·»åŠ åˆ°äº†æ± å­é‡Œï¼Œå› ä¸ºä¹‹å‰å·²ç»æœ‰è¿‡é’ˆå¯¹æ­¤åŠŸèƒ½çš„æµ‹è¯•æ ·ä¾‹äº†</p>
</blockquote>
<p>åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦42 USDCï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>token1.mint(<span style="color:#66d9ef">address</span>(this), <span style="color:#ae81ff">42</span> <span style="color:#66d9ef">ether</span>);
</span></span></code></pre></div><p>äº¤æ˜“ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°callbackå‡½æ•°ï¼Œæ¥ç¡®ä¿èƒ½å¤Ÿå°†é’±è½¬ç»™æ± å­åˆçº¦ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">uniswapV3SwapCallback</span>(<span style="color:#66d9ef">int256</span> amount0, <span style="color:#66d9ef">int256</span> amount1) <span style="color:#66d9ef">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (amount0 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        token0.transfer(msg.sender, <span style="color:#66d9ef">uint256</span>(amount0));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (amount1 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        token1.transfer(msg.sender, <span style="color:#66d9ef">uint256</span>(amount1));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç”±äºäº¤æ˜“ä¸­çš„æ•°é¢å¯ä»¥ä¸ºæ­£æˆ–è´Ÿï¼ˆä»æ± å­ä¸­æ‹¿èµ°çš„æ•°é‡ï¼‰ï¼Œåœ¨callbackä¸­æˆ‘ä»¬åªå‘å‡ºæ•°é¢ä¸ºæ­£çš„å¯¹åº”tokenï¼Œä¹Ÿå³æˆ‘ä»¬å¸Œæœ›å–å‡ºçš„tokenã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>swap</code>äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>(<span style="color:#66d9ef">int256</span> amount0Delta, <span style="color:#66d9ef">int256</span> amount1Delta) <span style="color:#f92672">=</span> pool.swap(<span style="color:#66d9ef">address</span>(this));
</span></span></code></pre></div><p>å‡½æ•°è¿”å›äº†åœ¨æœ¬æ¬¡äº¤æ˜“ä¸­æ¶‰åŠåˆ°çš„ä¸¤ç§tokenæ•°é‡ï¼Œæˆ‘ä»¬éœ€è¦éªŒè¯ä¸€ä¸‹å®ƒä»¬æ˜¯å¦æ­£ç¡®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>assertEq(amount0Delta, <span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">008396714242162444</span> <span style="color:#66d9ef">ether</span>, <span style="color:#e6db74">&#34;invalid ETH out&#34;</span>);
</span></span><span style="display:flex;"><span>assertEq(amount1Delta, <span style="color:#ae81ff">42</span> <span style="color:#66d9ef">ether</span>, <span style="color:#e6db74">&#34;invalid USDC in&#34;</span>);
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦éªŒè¯tokençš„ç¡®ä»è°ƒç”¨è€…ï¼ˆè¯‘è€…æ³¨ï¼šä¹Ÿå³æœ¬æµ‹è¯•åˆçº¦ï¼‰å¤„è½¬å‡ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>assertEq(
</span></span><span style="display:flex;"><span>    token0.balanceOf(<span style="color:#66d9ef">address</span>(this)),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint256</span>(userBalance0Before <span style="color:#f92672">-</span> amount0Delta),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;invalid user ETH balance&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>assertEq(
</span></span><span style="display:flex;"><span>    token1.balanceOf(<span style="color:#66d9ef">address</span>(this)),
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;invalid user USDC balance&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>å¹¶ä¸”è¢«å‘é€åˆ°äº†æ± å­åˆçº¦ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>assertEq(
</span></span><span style="display:flex;"><span>    token0.balanceOf(<span style="color:#66d9ef">address</span>(pool)),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint256</span>(<span style="color:#66d9ef">int256</span>(poolBalance0) <span style="color:#f92672">+</span> amount0Delta),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;invalid pool ETH balance&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>assertEq(
</span></span><span style="display:flex;"><span>    token1.balanceOf(<span style="color:#66d9ef">address</span>(pool)),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint256</span>(<span style="color:#66d9ef">int256</span>(poolBalance1) <span style="color:#f92672">+</span> amount1Delta),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;invalid pool USDC balance&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>æœ€åï¼Œæˆ‘ä»¬éªŒè¯æ± å­çš„çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span>(<span style="color:#66d9ef">uint160</span> sqrtPriceX96, <span style="color:#66d9ef">int24</span> tick) <span style="color:#f92672">=</span> pool.slot0();
</span></span><span style="display:flex;"><span>assertEq(
</span></span><span style="display:flex;"><span>    sqrtPriceX96,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">5604469350942327889444743441197</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;invalid current sqrtP&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>assertEq(tick, <span style="color:#ae81ff">85184</span>, <span style="color:#e6db74">&#34;invalid current tick&#34;</span>);
</span></span><span style="display:flex;"><span>assertEq(
</span></span><span style="display:flex;"><span>    pool.liquidity(),
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1517882343751509868544</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;invalid current liquidity&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>æ³¨æ„åˆ°ï¼Œåœ¨è¿™é‡Œäº¤æ˜“å¹¶æ²¡æœ‰æ”¹å˜æ± å­æµåŠ¨æ€§â€”â€”åœ¨åé¢çš„æŸä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å®ƒå°†å¦‚ä½•æ”¹å˜</p>
<h2 id="ç»ƒä¹ ">
  ç»ƒä¹ 
  <a class="anchor" href="#%e7%bb%83%e4%b9%a0">#</a>
</h2>
<p>å†™ä¸€ä¸ªæµ‹è¯•æ ·ä¾‹ï¼Œå¤±è´¥å¹¶æŠ¥é”™<code>InsufficientInputAmount</code>ã€‚è¦è®°å¾—ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªéšè—çš„bugğŸ™‚</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#ç¬¬ä¸€ç¬”äº¤æ˜“">ç¬¬ä¸€ç¬”äº¤æ˜“</a>
      <ul>
        <li><a href="#è®¡ç®—äº¤æ˜“æ•°é‡">è®¡ç®—äº¤æ˜“æ•°é‡</a></li>
        <li><a href="#å®ç°swap">å®ç°swap</a></li>
        <li><a href="#æµ‹è¯•äº¤æ˜“">æµ‹è¯•äº¤æ˜“</a></li>
        <li><a href="#ç»ƒä¹ ">ç»ƒä¹ </a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












