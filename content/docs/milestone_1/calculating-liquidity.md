---
title: "è®¡ç®—æµåŠ¨æ€§"
weight: 2
# bookFlatSection: false
# bookToc: true
# bookHidden: false
# bookCollapseSection: false
# bookComments: false
# bookSearchExclude: false
---

{{< katex display >}} {{</ katex >}}

# è®¡ç®—æµåŠ¨æ€§

æ²¡æœ‰æµåŠ¨æ€§å°±æ— æ³•è¿›è¡Œäº¤æ˜“ã€‚ä¸ºäº†èƒ½å¤Ÿå®Œæˆæˆ‘ä»¬çš„ç¬¬ä¸€ç¬”äº¤æ˜“ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å‘æ± å­ä¸­æ·»åŠ ä¸€äº›æµåŠ¨æ€§ã€‚è€Œä¸ºäº†å‘æ± å­åˆçº¦æ·»åŠ æµåŠ¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼š

1. ä¸€ä¸ªä»·æ ¼åŒºé—´ï¼Œå³ LP å¸Œæœ›ä»–çš„æµåŠ¨æ€§ä»…åœ¨è¿™ä¸ªåŒºé—´ä¸Šæä¾›å’Œè¢«åˆ©ç”¨ï¼›
2. æä¾›æµåŠ¨æ€§çš„æ•°é‡ï¼Œä¹Ÿå³æä¾›çš„ä¸¤ç§ä»£å¸çš„æ•°é‡ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒä»¬è½¬å…¥æ± å­åˆçº¦ã€‚

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šæ‰‹åŠ¨è®¡ç®—ä¸Šè¿°å˜é‡çš„å€¼ï¼›åœ¨åç»­ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨åˆçº¦ä¸­å¯¹æ­¤è¿›è¡Œå®ç°ã€‚

é¦–å…ˆæˆ‘ä»¬æ¥è€ƒè™‘ä»·æ ¼åŒºé—´ã€‚

## ä»·æ ¼åŒºé—´è®¡ç®—
å›å¿†ä¸€ä¸‹ä¸Šä¸€ç« æ‰€è®²ï¼Œåœ¨ Uniswap V3 ä¸­ï¼Œæ•´ä¸ªä»·æ ¼åŒºé—´è¢«åˆ’åˆ†æˆäº† ticksï¼šæ¯ä¸ª tick å¯¹åº”ä¸€ä¸ªä»·æ ¼ï¼Œä»¥åŠæœ‰ä¸€ä¸ªä¸‹æ ‡ã€‚åœ¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå®ç°ä¸­ï¼Œæˆ‘ä»¬çš„ç°è´§ä»·æ ¼è®¾ç½®ä¸º 1 ETH å¯¹ 5000 USDCã€‚è´­ä¹° ETH ä¼šç§»é™¤æ± å­ä¸­çš„ä¸€éƒ¨åˆ† ETHï¼Œä»è€Œä½¿å¾—ä»·æ ¼å˜å¾—é«˜äº 5000 USDCã€‚æˆ‘ä»¬å¸Œæœ›åœ¨ä¸€ä¸ªåŒ…å«æ­¤ä»·æ ¼çš„åŒºé—´ä¸­æä¾›æµåŠ¨æ€§ï¼Œå¹¶ä¸”è¦ç¡®ä¿æœ€ç»ˆçš„ä»·æ ¼**è½åœ¨è¿™ä¸ªåŒºé—´å†…**ã€‚ï¼ˆè·¨åŒºé—´çš„äº¤æ˜“å°†ä¼šåœ¨åç»­ç« èŠ‚æåˆ°ï¼‰ã€‚

æˆ‘ä»¬éœ€è¦æ‰¾åˆ° 3 ä¸ª tickï¼š
1. å¯¹åº”ç°è´§ä»·æ ¼çš„ tickï¼ˆ1 ETH - 5000 USDCï¼‰
2. æä¾›æµåŠ¨æ€§çš„ä»·æ ¼åŒºé—´ä¸Šä¸‹ç•Œå¯¹åº”çš„ tickã€‚åœ¨è¿™é‡Œï¼Œä¸‹ç•Œä¸º 4545 USDCï¼Œä¸Šç•Œä¸º 5500 USDCã€‚

ä»ä¹‹å‰çš„ç« èŠ‚ä¸­æˆ‘ä»¬çŸ¥é“ä¸‹è¿°å…¬å¼ï¼š

$$\sqrt{P} = \sqrt{\frac{y}{x}}$$

ç”±äºæˆ‘ä»¬æŠŠ ETH ä½œä¸ºèµ„äº§ $x$ï¼ŒUSDC ä½œä¸ºèµ„äº§ $y$ï¼Œæ¯ä¸ª tick å¯¹åº”çš„å€¼ä¸ºï¼š

$$\sqrt{P_c} = \sqrt{\frac{5000}{1}} = \sqrt{5000} \approx 70.71$$

$$\sqrt{P_l} = \sqrt{\frac{4545}{1}} \approx 67.42$$

$$\sqrt{P_u} = \sqrt{\frac{5500}{1}} \approx 74.16$$

åœ¨è¿™é‡Œï¼Œ$P_c$ ä»£è¡¨ç°è´§ä»·æ ¼ï¼Œ$P_l$ ä»£è¡¨åŒºé—´ä¸‹ç•Œï¼Œ$P_u$ ä»£è¡¨åŒºé—´ä¸Šç•Œã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—ä»·æ ¼å¯¹åº”çš„ ticksã€‚ä½¿ç”¨ä¸‹é¢å…¬å¼ï¼š

$$\sqrt{P(i)}=1.0001^{\frac{i}{2}}$$

æˆ‘ä»¬å¯ä»¥å¾—åˆ°å…³äº $i$ çš„å…¬å¼ï¼š

$$i = log_{\sqrt{1.0001}} \sqrt{P(i)}$$

> å…¬å¼ä¸­çš„ä¸¤ä¸ªæ ¹å·å®é™…ä¸Šæ˜¯å¯ä»¥æ¶ˆå»çš„ï¼Œä½†ç”±äºæˆ‘ä»¬ä¼šä½¿ç”¨ $\sqrt{p}$ è¿›è¡Œè®¡ç®—ï¼Œè¿™é‡Œé€‰æ‹©ä¿ç•™æ ¹å·

è¿™å‡ ä¸ªå¯¹åº”çš„ tick åˆ†åˆ«ä¸º:
1. ç°ä»· tick: $i_c = log_{\sqrt{1.0001}} 70.71 = 85176$
2. ä¸‹ç•Œ tick: $i_l = log_{\sqrt{1.0001}} 67.42 = 84222$
3. ä¸Šç•Œ tick: $i_u = log_{\sqrt{1.0001}} 74.16 = 86129$

> ä¸Šè¿°è®¡ç®—ä½¿ç”¨çš„æ˜¯ Pythonï¼š
> ```python
> import math
>
> def price_to_tick(p):
>     return math.floor(math.log(p, 1.0001))
>
> price_to_tick(5000)
> > 85176
>```

ä»·æ ¼åŒºé—´çš„è®¡ç®—å°±æ˜¯è¿™æ ·ã€‚

æœ€åéœ€è¦æåˆ°çš„æ˜¯ï¼Œåœ¨ Solidity ä¸­ï¼ŒUniswap ä½¿ç”¨ Q64.96 æ¥å­˜å‚¨ $\sqrt{p}$ã€‚è¿™æ˜¯ä¸€ä¸ªæ•´æ•°ä½ç”±64ä½è¡¨ç¤ºã€å°æ•°ä½ç”±96ä½è¡¨ç¤ºçš„å®šç‚¹æ•°æ ¼å¼ã€‚åœ¨æˆ‘ä»¬ä¸Šé¢çš„è®¡ç®—ä¸­ï¼Œä»·æ ¼æŒ‰ç…§æµ®ç‚¹æ•°å½¢å¼è®¡ç®—ï¼š`70.71`, `67.42`, `74.16`ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬è½¬æ¢æˆ Q64.96 æ ¼å¼ï¼Œä¹Ÿéå¸¸ç®€å•ï¼šåªéœ€è¦å°†è¿™ä¸ªæ•°ä¹˜ä»¥ $2^{96}$ï¼Œå³å¯å¾—åˆ°ï¼š

$$\sqrt{P_c} = 5602277097478614198912276234240$$

$$\sqrt{P_l} = 5314786713428871004159001755648$$

$$\sqrt{P_u} = 5875717789736564987741329162240$$

> åœ¨ Python ä¸­ï¼š
> ```python
> q96 = 2**96
> def price_to_sqrtp(p):
>     return int(math.sqrt(p) * q96)
>
> price_to_sqrtp(5000)
> > 5602277097478614198912276234240
> ```
> æ³¨æ„å…ˆè¿›è¡Œä¹˜æ³•å†å–æ•´ï¼Œå¦åˆ™ä¼šæŸå¤±ç²¾åº¦

## Token æ•°é‡è®¡ç®—

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šå‘æ± å­ä¸­æŠ•å…¥å¤šå°‘ tokenã€‚ç­”æ¡ˆæ˜¯ï¼šè¶Šå¤šè¶Šå¥½ã€‚æ•°é‡å¹¶æ²¡æœ‰ä¸¥æ ¼å®šä¹‰ï¼Œæˆ‘ä»¬è´¨æŠ¼çš„æ•°ç›®è¶Šå¤šï¼Œè´­ä¹°åŒæ ·æ•°é‡çš„ ETH å°±ä¼šä½¿å¾—ä»·æ ¼çš„å˜åŠ¨è¶Šå°ï¼Œé˜²æ­¢ç¦»å¼€æˆ‘ä»¬çš„ä»·æ ¼åŒºé—´ã€‚åœ¨å¼€å‘å’Œæµ‹è¯•æ™ºèƒ½åˆçº¦çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ä»»æ„æ•°é‡çš„ tokenï¼Œæ‰€ä»¥é’±ä¸æ˜¯é—®é¢˜ã€‚

ä¸ºäº†å®ç°æˆ‘ä»¬çš„ç¬¬ä¸€ç¬”äº¤æ˜“ï¼Œæˆ‘ä»¬å°†ä¼šåœ¨æ± å­ä¸­è´¨æŠ¼ 1 ETH å’Œ 5000 USDCã€‚


> è¦è®°å¾—æ± å­ä¸­èµ„äº§æ•°é‡çš„æ¯”ä¾‹å†³å®šäº†ç°è´§ä»·æ ¼ã€‚æ‰€ä»¥å‡è®¾æˆ‘ä»¬å¸Œæœ›åƒæ± å­ä¸­æŠ•å…¥æ›´å¤šçš„èµ„äº§è€Œä¿æŒç°è´§ä»·æ ¼ä¸å˜ï¼Œæˆ‘ä»¬æŠ•å…¥çš„èµ„äº§ä¹Ÿå¿…é¡»æ»¡è¶³åŒæ ·çš„æ¯”ä¾‹ï¼Œä¾‹å¦‚ï¼š2 ETH å’Œ 10,000 USDCï¼›10 ETH å’Œ 50,000 USDCã€‚

## æµåŠ¨æ€§æ•°é‡è®¡ç®—

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åŸºäºæˆ‘ä»¬è´¨æŠ¼ token çš„æ•°é‡è®¡ç®—æµåŠ¨æ€§ $L$ çš„å€¼ã€‚è¿™éƒ¨åˆ†å¯èƒ½ç•¥æœ‰éš¾åº¦ï¼Œè®°å¾—è·Ÿç´§ï¼


æ ¹æ®ä¹‹å‰æˆ‘ä»¬æåˆ°è¿‡çš„å…¬å¼ï¼ŒæµåŠ¨æ€§æ•°é‡å¦‚ä¸‹è®¡ç®—ï¼š

$$L = \sqrt{xy}$$

ç„¶è€Œï¼Œä¸Šè¿°å…¬å¼æ˜¯ç”¨äºæ— ç©·ä»·æ ¼åŒºé—´æ›²çº¿çš„ ğŸ™‚ã€‚ä½†æˆ‘ä»¬å¸Œæœ›çš„æ˜¯æŠŠæµåŠ¨æ€§æ”¾åœ¨æŸä¸ªæœ‰ç•Œçš„ä»·æ ¼åŒºé—´ï¼Œä¹Ÿå³æ— ç©·æ›²çº¿çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬éœ€è¦é’ˆå¯¹æˆ‘ä»¬å¸Œæœ›æµåŠ¨æ€§å­˜åœ¨çš„ä»·æ ¼åŒºé—´æ¥è®¡ç®—å¯¹åº”çš„ $L$ï¼Œå› æ­¤å¯èƒ½éœ€è¦ä¸€äº›æ›´å¤æ‚çš„è®¡ç®—ã€‚

ä¸ºäº†è®¡ç®—è¿™ä¸ªä»·æ ¼åŒºé—´çš„ $L$ï¼Œæˆ‘ä»¬æ¥å›é¡¾æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡çš„ä¸€ä¸ªæœ‰è¶£çš„ç‚¹ï¼šä»·æ ¼åŒºé—´å¯ä»¥è¢«**è€—å°½**ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªä»·æ ¼åŒºé—´çš„æŸç§ token å…¨éƒ¨ä¹°èµ°ï¼Œä½¿å¾—è¯¥åŒºé—´ä¸­åªæœ‰å¦ä¸€ç§ tokenï¼š

![Range depletion example](/images/milestone_1/range_depleted.png)

åœ¨ä¸Šå›¾ä¸­çš„ä¸¤ä¸ªè¾¹ç•Œç‚¹ï¼ŒåŒºé—´æµåŠ¨æ€§æ± ä¸­éƒ½åªæœ‰ä¸€ç§ tokenï¼šåœ¨ $a$ ç‚¹æ± å­é‡Œåªæœ‰ ETHï¼Œåœ¨ $b$ ç‚¹åªæœ‰ USDCã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ‰¾åˆ°ä¸€ä¸ª $L$ï¼Œä½¿å¾—ä»·æ ¼èƒ½å¤Ÿç§»åŠ¨åˆ°ä¸¤ä¸ªç«¯ç‚¹å¤„ã€‚æˆ‘ä»¬éœ€è¦è¶³å¤Ÿçš„æµåŠ¨æ€§æ¥ä½¿å¾—ä»·æ ¼èƒ½å¤Ÿè¾¾åˆ°ä¸Šä¸‹ç•Œï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›é€šè¿‡ $\Delta x$ å’Œ $\Delta y$ çš„æœ€å¤§å€¼æ¥è®¡ç®—æµåŠ¨æ€§ã€‚

ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¾¹ç•Œç‚¹çš„ä»·æ ¼ã€‚å½“ä»æ± å­ä¸­è´­ä¹° ETH æ—¶ï¼Œä»·æ ¼ä¼šå‡é«˜ï¼›å½“ä»æ± å­ä¸­è´­ä¹° USDCï¼ˆå–å‡º ETHï¼‰æ—¶ï¼Œä»·æ ¼ä¼šä¸‹è·Œã€‚ç”±äºä»·æ ¼ä¸º $\frac{y}{x}$ï¼Œæ‰€ä»¥ $a$ ç‚¹ä¸ºä»·æ ¼æœ€ä½ç‚¹ï¼Œ$b$ ç‚¹ä¸ºä»·æ ¼æœ€é«˜ç‚¹ã€‚

> äº‹å®ä¸Šï¼ŒæŒ‰ç…§å…¬å¼ï¼Œåœ¨è¿™ä¸¤ä¸ªç‚¹çš„ä»·æ ¼æ˜¯æ²¡æœ‰å®šä¹‰çš„ï¼Œå› ä¸ºæ± å­ä¸­åªæœ‰ä¸€ç§ tokenï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œåªéœ€è¦ç†è§£ï¼Œ$b$ ç‚¹çš„ä»·æ ¼é«˜äºèµ·å§‹ä»·æ ¼ï¼Œ$a$ ç‚¹ä»·æ ¼ä½äºèµ·å§‹ä»·æ ¼å³å¯ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°†å›¾ä¸­çš„æ›²çº¿åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šèµ·å§‹ç‚¹å·¦è¾¹å’Œèµ·å§‹ç‚¹å³è¾¹ã€‚æˆ‘ä»¬å°†åœ¨ä¸¤è¾¹**åˆ†åˆ«**è®¡ç®—å‡º $L$ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ªï¼Ÿå› ä¸ºæ± å­ä¸­çš„ä¸¤ç§èµ„äº§åˆ†åˆ«å¯¹**å…¶ä¸­ä¸€è¾¹**èµ·ä½œç”¨ï¼šå·¦åŠè¾¹å®Œå…¨ç”± token $x$ ç»„æˆï¼Œå³åŠè¾¹å®Œå…¨ç”± token $y$ ç»„æˆã€‚è¿™æ˜¯å› ä¸ºï¼Œåœ¨äº¤æ˜“è¿‡ç¨‹ä¸­ï¼Œä»·æ ¼ä¼šæœç€æŸä¸ªæ–¹å‘ç§»åŠ¨ï¼šå‡é«˜æˆ–é™ä½ã€‚å¯¹äºä»·æ ¼çš„ç§»åŠ¨ï¼Œä»…æœ‰ä¸€ç§ token ä¼šèµ·ä½œç”¨ï¼š
1. å½“ä»·æ ¼å‡é«˜æ—¶ï¼Œäº¤æ˜“ä»…éœ€è¦ token $x$ï¼ˆå› ä¸ºæˆ‘ä»¬ä»æ± å­ä¸­è´­ä¹° token $x$ï¼‰
2. å½“ä»·æ ¼é™ä½æ—¶ï¼Œäº¤æ˜“ä»…éœ€è¦ token $y$

å› æ­¤ï¼Œå·¦åŠè¾¹çš„æµåŠ¨æ€§ä»…ç”± token $x$æä¾›ï¼Œå› æ­¤åªé€šè¿‡ token $x$ æ•°é‡è®¡ç®—å‡ºæ¥ã€‚ç±»ä¼¼åœ°ï¼Œå³è¾¹çš„æµåŠ¨æ€§ä»…ç”± token $y$ æä¾›å› æ­¤ä»…ç”±æä¾›çš„ token $y$ æ•°é‡è®¡ç®—å‡ºæ¥ã€‚

![Liquidity on the curve](/images/milestone_1/curve_liquidity.png)

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬ä¼šè®¡ç®—å‡ºä¸¤ä¸ªä¸åŒçš„ $L$ å¹¶é€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚é€‰æ‹©å“ªä¸ªå‘¢ï¼Ÿé€‰æ‹©è¾ƒå°çš„é‚£ä¸ªã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè¾ƒå¤§çš„é‚£ä¸ªæµåŠ¨æ€§åŒ…å«äº†è¾ƒå°çš„æµåŠ¨æ€§ã€‚æˆ‘ä»¬å¸Œæœ›æµåŠ¨æ€§å‡åŒ€åˆ†å¸ƒåœ¨æˆ‘ä»¬æ‰€æä¾›çš„ä»·æ ¼åŒºé—´ä¸­ï¼Œå› æ­¤å·¦å³æä¾›çš„æµåŠ¨æ€§éœ€è¦ä¿æŒä¸€è‡´ã€‚å¦‚æœæˆ‘ä»¬é€‰æ‹©è¾ƒå¤§çš„é‚£ä¸ªï¼Œç”¨æˆ·æ‰€æä¾›çš„æŸç§ token çš„æ•°é‡å¯èƒ½ä¼šå¤§äºå…¶æŒ‡å®šçš„æ•°é‡ï¼Œæ¥å¹³è¡¡ä¸¤è¾¹çš„æµåŠ¨æ€§ã€‚è¿™çš„ç¡®ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ä¼šè®©æ•´ä¸ªæ™ºèƒ½åˆçº¦å˜å¾—æ›´åŠ å¤æ‚ã€‚

> é‚£ä¹ˆï¼Œè¾ƒå¤§çš„ $L$ æ€ä¹ˆåŠå‘¢ï¼Ÿå®é™…ä¸Šæ˜¯æ²¡æœ‰ç”¨çš„ã€‚æˆ‘ä»¬æŒ‘é€‰å°çš„é‚£ä¸ª $L$ï¼Œå¹¶ä¸”è®¡ç®—å‡ºè¿™ä¸ª $L$ å¯¹åº”çš„è¾ƒå¤§çš„ $L$ é‚£è¾¹ token çš„æ•°é‡â€”â€”ä¼šæ¯”ä¹‹å‰çš„è¦å°ã€‚è¿™æ ·ï¼Œä¸¤è¾¹çš„æµåŠ¨æ€§å°±ç›¸åŒäº†ï¼Œéƒ½ç­‰äºè¾ƒå°å€¼ã€‚

æœ€åè¿˜éœ€è¦è¯´æ˜çš„ä¸€ä¸ªå…³é”®ç‚¹æ˜¯ï¼š**æ–°çš„æµåŠ¨æ€§éœ€è¦ä¿è¯ä¸æ”¹å˜ç°è´§ä»·æ ¼**ã€‚ä¹Ÿå³ï¼Œå®ƒå¿…é¡»ä¸ç°åœ¨ä¸¤ç§èµ„äº§çš„æ•°é‡æˆæ¯”ä¾‹ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸Šé¢ä¼šè®¡ç®—å‡ºä¸¤ä¸ª $L$ â€”â€”å› ä¸ºä»…è€ƒè™‘äº†ä¸€ç§èµ„äº§ï¼Œè€Œæ²¡æœ‰ä¿è¯æ¯”ä¾‹ã€‚æˆ‘ä»¬é€‰æ‹©è¾ƒå°çš„é‚£ä¸ª $L$ æ¥é‡æ–°è®¡ç®—æ¯”ä¾‹ã€‚

ä¸Šé¢çš„è¯´æ˜æœ‰äº›ç»•ï¼Œæˆ–è®¸åœ¨åé¢å®ç°ä»£ç çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šå¯¹æ­¤ç†è§£æ›´æ¸…æ™°å§ã€‚ç°åœ¨æˆ‘ä»¬æ¥çœ‹å…¬å¼ã€‚

å›å¿†ä¸€ä¸‹ï¼Œ $\Delta x$ å’Œ $\Delta y$ çš„è®¡ç®—å…¬å¼ä¸ºï¼š

$$\Delta x = \Delta \frac{1}{\sqrt{P}} L$$
$$\Delta y = \Delta \sqrt{P} L$$

æˆ‘ä»¬æŠŠä¸Šè¿°å…¬å¼ä¸­çš„ $\Delta \sqrt{P}$ ç›¸å…³éƒ¨åˆ†å±•å¼€ï¼š

$$\Delta x = (\frac{1}{\sqrt{P_c}} - \frac{1}{\sqrt{P_b}}) L$$
$$\Delta y = (\sqrt{P_c} - \sqrt{P_a}) L$$

$P_a$ æ˜¯ $a$ ç‚¹çš„ä»·æ ¼ï¼Œ$P_b$ æ˜¯ $b$ ç‚¹çš„ä»·æ ¼, $P_c$ æ˜¯ç°è´§ä»·æ ¼ã€‚

æˆ‘ä»¬æ¥ä¸‹æ¥æ ¹æ®ç¬¬ä¸€ä¸ªå…¬å¼æ¨å¯¼å‡ºè®¡ç®— $L$ çš„å…¬å¼ï¼š

$$\Delta x = (\frac{1}{\sqrt{P_c}} - \frac{1}{\sqrt{P_b}}) L$$
$$\Delta x = \frac{L}{\sqrt{P_c}} - \frac{L}{\sqrt{P_b}}$$
$$\Delta x = \frac{L(\sqrt{P_b} - \sqrt{P_c})}{\sqrt{P_b} \sqrt{P_c}}$$
$$L = \Delta x \frac{\sqrt{P_b} \sqrt{P_c}}{\sqrt{P_b} - \sqrt{P_c}}$$

ä»ç¬¬äºŒä¸ªå…¬å¼æ¨å¯¼:
$$\Delta y = (\sqrt{P_c} - \sqrt{P_a}) L$$
$$L = \frac{\Delta y}{\sqrt{P_c} - \sqrt{P_a}}$$

è¿™å°±æ˜¯æˆ‘ä»¬çš„ä¸¤ä¸ª $L$ çš„è®¡ç®—å…¬å¼ï¼Œè·Ÿåˆ«å¯¹åº”èµ·å§‹ç‚¹ä¸¤è¾¹çš„ä¸¤æ®µæ›²çº¿:

$$L = \Delta x \frac{\sqrt{P_b} \sqrt{P_c}}{\sqrt{P_b} - \sqrt{P_c}}$$
$$L = \frac{\Delta y}{\sqrt{P_c} - \sqrt{P_a}}$$

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠä¹‹å‰è®¡ç®—å‡ºçš„ä»·æ ¼ä»£å…¥å…¬å¼:

$$L = \Delta x \frac{\sqrt{P_b}\sqrt{P_c}}{\sqrt{P_b}-\sqrt{P_c}} = 1 ETH * \frac{74.16 * 70.71}{74.16 - 70.71}$$
è½¬æ¢æˆ Q64.96 åå¾—åˆ°:

$$L = 1519437308014769733632$$

å¯¹äºå¦ä¸€ä¸ª $L$:
$$L = \frac{\Delta y}{\sqrt{P_c}-\sqrt{P_a}} = \frac{5000USDC}{70.71 - 67.42}$$
$$L = 1517882343751509868544$$

ä¸¤è€…ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©å°çš„é‚£ä¸€ä¸ª

> Python è®¡ç®—:
> ```python
> sqrtp_low = price_to_sqrtp(4545)
> sqrtp_cur = price_to_sqrtp(5000)
> sqrtp_upp = price_to_sqrtp(5500)
> 
> def liquidity0(amount, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return (amount * (pa * pb) / q96) / (pb - pa)
>
> def liquidity1(amount, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return amount * q96 / (pb - pa)
> 
> liq0 = liquidity0(amount_eth, sqrtp_cur, sqrtp_upp)
> liq1 = liquidity1(amount_usdc, sqrtp_cur, sqrtp_low)
> liq = int(min(liq0, liq1))
> > 1517882343751509868544
> ```



## é‡æ–°è®¡ç®— token æ•°é‡

å°½ç®¡æˆ‘ä»¬åˆå§‹é€‰æ‹©äº†æˆ‘ä»¬æƒ³è¦è´¨æŠ¼çš„ token æ•°ç›®ï¼Œè¿™ä¸ªæ•°ç›®å¯èƒ½å¹¶ä¸å‡†ç¡®ã€‚æˆ‘ä»¬å¹¶ä¸èƒ½åœ¨ä»»ä½•ä»·æ ¼åŒºé—´è´¨æŠ¼ä»»ä½•æ¯”ä¾‹çš„ token æ¥è·å–æµåŠ¨æ€§ï¼Œå› ä¸ºæµåŠ¨æ€§éœ€è¦æ»¡è¶³åœ¨ä»·æ ¼åŒºé—´çš„æ›²çº¿ä¸Šå‡åŒ€åˆ†å¸ƒã€‚å› æ­¤ï¼Œå°½ç®¡ç”¨æˆ·é€‰æ‹©äº†èµ·å§‹æ•°é‡ï¼Œåˆçº¦ä¼šå¯¹å®ƒä»¬é‡æ–°è®¡ç®—ï¼Œæ‰€ä»¥å®é™…çš„æ•°é‡ä¼šç•¥æœ‰ä¸åŒï¼ˆè‡³å°‘ä¼šæœ‰å–æ•´çš„ç²¾åº¦é—®é¢˜ï¼‰

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†å¯¹åº”çš„å…¬å¼ï¼š

$$\Delta x = \frac{L(\sqrt{P_b} - \sqrt{P_c})}{\sqrt{P_b} \sqrt{P_c}}$$
$$\Delta y = L(\sqrt{P_c} - \sqrt{P_a})$$

> åœ¨ Python ä¸­:
> ```python
> def calc_amount0(liq, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return int(liq * q96 * (pb - pa) / pa / pb)
> 
> 
> def calc_amount1(liq, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return int(liq * (pb - pa) / q96)
>
> amount0 = calc_amount0(liq, sqrtp_upp, sqrtp_cur)
> amount1 = calc_amount1(liq, sqrtp_low, sqrtp_cur)
> (amount0, amount1)
> > (998976618347425408, 5000000000000000000000)
> ```
> æ­£å¦‚ä¸Šè¿°è®¡ç®—ç»“æœï¼Œå¾—åˆ°çš„æ•°æ®åŸºæœ¬ç­‰äºæˆ‘ä»¬æƒ³è¦æä¾›çš„æ•°é‡ï¼Œä¸è¿‡ ETH ç•¥å°‘ä¸€ç‚¹

> **Hint**: ä½¿ç”¨ `cast --from-wei AMOUNT` æ¥æŠŠweiè½¬æ¢æˆether, ç¤ºä¾‹:  
> `cast --from-wei 998976618347425280` è¾“å‡º `0.998976618347425280`.
